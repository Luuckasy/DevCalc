<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DevEx Manager Final</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --surface: #1a1a1a;
            --surface-light: #252525;
            --primary: #00e68e;
            --text-main: #ffffff;
            --text-sec: #999;
            --border: #333;
            --danger: #ff4d4d;
            --input-bg: #121212;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            overscroll-behavior: none;
        }

        .app-container {
            background-color: var(--surface);
            width: 100%;
            max-width: 500px;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        h2 { margin: 0; font-size: 1.2rem; color: var(--primary); }
        .rate-badge {
            background: var(--surface-light);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .rate-input {
            width: 50px;
            background: transparent;
            border: none;
            color: white;
            font-weight: bold;
            text-align: right;
            font-size: 1rem;
        }
        .icon-btn { background: none; border: none; font-size: 1.1rem; padding: 0; cursor: pointer; }

        /* INPUTS */
        .input-stack { display: flex; flex-direction: column; gap: 12px; }
        .big-input-group { position: relative; }
        .big-input-group label {
            position: absolute; top: 8px; left: 12px; font-size: 0.75rem; color: var(--text-sec); font-weight: 700;
        }
        .big-input {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--border);
            padding: 24px 12px 8px 12px;
            border-radius: 10px;
            color: white;
            font-size: 1.2rem;
            box-sizing: border-box;
            transition: border 0.2s;
        }
        .big-input:focus { outline: none; border-color: var(--primary); background: #161616; }
        
        /* Cores indicativas */
        #inp-robux { border-left: 4px solid #00a2ff; }
        #inp-usd { border-left: 4px solid #28a745; }
        #inp-brl { border-left: 4px solid var(--primary); }

        /* SETTINGS GRID */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .small-input-group label { display: block; font-size: 0.75rem; color: var(--text-sec); margin-bottom: 4px; }
        .small-input {
            width: 100%; padding: 10px; background: var(--surface-light);
            border: 1px solid var(--border); border-radius: 8px; color: white; box-sizing: border-box;
        }

        /* SUMMARY */
        .financial-summary {
            background: #222; border-radius: 12px; padding: 15px; border: 1px solid var(--border);
        }
        .summary-row {
            display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #bbb;
        }
        .summary-row.highlight {
            color: white; font-weight: bold; border-top: 1px solid #333; padding-top: 8px; margin-top: 8px; font-size: 1rem;
        }
        .val-gross { color: #f0ad4e; }
        .val-tax { color: var(--danger); }
        .val-net { color: var(--primary); }

        /* PARTNERS */
        .partners-section {
            background: var(--surface-light); border-radius: 12px; padding: 15px;
        }
        .partners-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .btn-add {
            background: #00b06f; color: white; border: none; padding: 5px 12px;
            border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer;
        }
        .partner-list { display: flex; flex-direction: column; gap: 8px; }
        .partner-row {
            display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.2);
            padding: 8px; border-radius: 8px;
        }
        .p-name { flex: 2; background: transparent; border: none; color: white; border-bottom: 1px solid #444; padding: 4px; }
        .p-pct { width: 50px; background: #111; border: 1px solid #444; color: var(--primary); text-align: center; border-radius: 4px; padding: 5px; }
        .p-result { flex: 2; text-align: right; font-size: 0.85rem; line-height: 1.2; }
        .p-tax-share { font-size: 0.7rem; color: #666; display: block; }
        .btn-del { color: #666; background: none; border: none; font-size: 1.2rem; padding: 0 5px; }

        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: #000; padding: 8px 20px;
            border-radius: 20px; font-weight: bold; font-size: 0.85rem;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div>
            <h2>DevEx Manager</h2>
            <div style="font-size: 0.7rem; color: #666;">Ultimate v6</div>
        </div>
        <div class="rate-badge">
            <span style="font-size: 0.8rem; color: var(--primary);">USD</span>
            <input type="number" id="usd-rate" class="rate-input" value="5.25" disabled step="0.01">
            <button class="icon-btn" id="btn-lock">üîí</button>
            <button class="icon-btn" id="btn-refresh">üîÑ</button>
        </div>
    </header>

    <div class="input-stack">
        <div class="big-input-group">
            <label>üéÆ ROBUX</label>
            <input type="number" id="inp-robux" class="big-input" placeholder="0">
        </div>
        <div class="big-input-group">
            <label>üá∫üá∏ USD (Bruto)</label>
            <input type="number" id="inp-usd" class="big-input" placeholder="0.00">
        </div>
        <div class="big-input-group">
            <label>üáßüá∑ BRL (L√≠quido Estimado)</label>
            <input type="number" id="inp-brl" class="big-input" placeholder="0,00">
        </div>
    </div>

    <div class="settings-grid">
        <div class="small-input-group">
            <label>Taxa DevEx</label>
            <select id="cfg-devex" class="small-input">
                <option value="0.0038" selected>Nova ($0.0038)</option>
                <option value="0.0035">Antiga ($0.0035)</option>
            </select>
        </div>
        <div class="small-input-group">
            <label>Fee Banco ($)</label>
            <input type="number" id="cfg-fee" class="small-input" value="26">
        </div>
        <div class="small-input-group">
            <label>Imposto Base (%)</label>
            <input type="number" id="cfg-tax" class="small-input" value="10.82">
        </div>
        <div style="display: flex; align-items: center; gap: 8px; padding-top: 15px;">
            <input type="checkbox" id="cfg-extra" style="width: 20px; height: 20px;">
            <label for="cfg-extra" style="font-size: 0.8rem; line-height: 1.1;">Lucro > 50k<br>(+10%)</label>
        </div>
    </div>

    <div class="financial-summary">
        <div class="summary-row">
            <span>Faturamento Bruto (BRL)</span>
            <span id="res-gross-brl" class="val-gross">R$ 0,00</span>
        </div>
        <div class="summary-row">
            <span>Impostos Totais</span>
            <span id="res-total-tax" class="val-tax">R$ 0,00</span>
        </div>
        <div class="summary-row highlight">
            <span>LUCRO L√çQUIDO TOTAL</span>
            <span id="res-net-brl" class="val-net">R$ 0,00</span>
        </div>
    </div>

    <div class="partners-section">
        <div class="partners-header">
            <span style="font-size: 0.9rem; font-weight: bold;">S√≥cios</span>
            <button class="btn-add" id="btn-add-partner">+ Add</button>
        </div>
        <div id="partners-list" class="partner-list"></div>
        <div style="margin-top: 10px; font-size: 0.75rem; color: #666; text-align: right;">
            Alocado: <span id="alloc-total">100%</span>
        </div>
    </div>
</div>

<div id="toast">Salvo!</div>

<script>
    // ESTADO GLOBAL
    const state = {
        usdRate: 5.00,
        manualRate: false,
        lastSource: 'robux', // 'robux', 'usd', ou 'brl' (Resolve o bug da reatividade)
        
        values: { robux: 0, grossUsd: 0, netBrl: 0, grossBrl: 0, totalTax: 0 },
        partners: [{ id: 1, name: 'Voc√™', pct: 100 }]
    };

    // ELEMENTOS
    const el = {
        robux: document.getElementById('inp-robux'),
        usd: document.getElementById('inp-usd'),
        brl: document.getElementById('inp-brl'), // Input L√≠quido
        
        devex: document.getElementById('cfg-devex'),
        fee: document.getElementById('cfg-fee'),
        tax: document.getElementById('cfg-tax'),
        extra: document.getElementById('cfg-extra'),
        
        usdRate: document.getElementById('usd-rate'),
        btnLock: document.getElementById('btn-lock'),
        btnRefresh: document.getElementById('btn-refresh'),
        
        resGrossBrl: document.getElementById('res-gross-brl'),
        resTotalTax: document.getElementById('res-total-tax'),
        resNetBrl: document.getElementById('res-net-brl'),
        
        pList: document.getElementById('partners-list'),
        btnAddP: document.getElementById('btn-add-partner'),
        allocTotal: document.getElementById('alloc-total'),
        toast: document.getElementById('toast')
    };

    // CALCULO CENTRAL
    function updateCalculations(source) {
        // Se a fonte for 'config', usamos a √∫ltima fonte editada pelo usu√°rio
        if (source === 'config') source = state.lastSource;
        else state.lastSource = source;

        // Inputs de Configura√ß√£o
        const rate = parseFloat(el.usdRate.value) || 5.00;
        const devex = parseFloat(el.devex.value);
        const fee = parseFloat(el.fee.value) || 0;
        let taxPct = parseFloat(el.tax.value) || 0;
        if (el.extra.checked) taxPct += 10;

        let v = state.values;

        // L√ìGICA DE FLUXO (CIMA P/ BAIXO ou BAIXO P/ CIMA)
        if (source === 'robux') {
            v.robux = parseFloat(el.robux.value) || 0;
            v.grossUsd = v.robux * devex;
            const netUsd = Math.max(0, v.grossUsd - fee);
            v.grossBrl = netUsd * rate;
            v.netBrl = v.grossBrl * (1 - (taxPct/100));
        } 
        else if (source === 'usd') {
            v.grossUsd = parseFloat(el.usd.value) || 0;
            v.robux = Math.ceil(v.grossUsd / devex);
            const netUsd = Math.max(0, v.grossUsd - fee);
            v.grossBrl = netUsd * rate;
            v.netBrl = v.grossBrl * (1 - (taxPct/100));
        }
        else if (source === 'brl') {
            // Engenharia Reversa (Meta L√≠quida -> Robux Necess√°rio)
            v.netBrl = parseFloat(el.brl.value) || 0;
            const taxFactor = 1 - (taxPct/100);
            v.grossBrl = taxFactor > 0 ? v.netBrl / taxFactor : 0;
            
            const netUsd = v.grossBrl / rate;
            // S√≥ adiciona a fee se tiver valor, senao distorce o zero
            v.grossUsd = netUsd > 0 ? netUsd + fee : 0;
            v.robux = Math.ceil(v.grossUsd / devex);
        }

        v.totalTax = v.grossBrl - v.netBrl;

        // ATUALIZAR INPUTS (Evita loop infinito no campo ativo)
        if (source !== 'robux') el.robux.value = v.robux > 0 ? v.robux : '';
        if (source !== 'usd') el.usd.value = v.grossUsd > 0 ? v.grossUsd.toFixed(2) : '';
        if (source !== 'brl') el.brl.value = v.netBrl > 0 ? v.netBrl.toFixed(2) : '';

        // ATUALIZAR RESUMO
        el.resGrossBrl.innerText = formatMoney(v.grossBrl);
        el.resTotalTax.innerText = formatMoney(v.totalTax);
        el.resNetBrl.innerText = formatMoney(v.netBrl);

        renderPartners();
        saveState();
    }

    // S√ìCIOS
    function renderPartners() {
        el.pList.innerHTML = '';
        let totalPct = 0;
        const netTotal = state.values.netBrl;
        const taxTotal = state.values.totalTax;

        state.partners.forEach((p, index) => {
            totalPct += p.pct;
            const pNet = netTotal * (p.pct / 100);
            const pTax = taxTotal * (p.pct / 100);

            const row = document.createElement('div');
            row.className = 'partner-row';
            row.innerHTML = `
                <input type="text" class="p-name" value="${p.name}" onchange="updatePartner(${index}, 'name', this.value)">
                <input type="number" class="p-pct" value="${p.pct}" onchange="updatePartner(${index}, 'pct', this.value)">
                <span style="font-size:0.8rem; color:#666;">%</span>
                <div class="p-result">
                    <div style="font-weight:bold; color:white;">${formatMoney(pNet)}</div>
                    <span class="p-tax-share">Imp: ${formatMoney(pTax)}</span>
                </div>
                ${index > 0 ? `<button class="btn-del" onclick="removePartner(${index})">√ó</button>` : ''}
            `;
            el.pList.appendChild(row);
        });

        el.allocTotal.innerText = totalPct + "%";
        el.allocTotal.style.color = totalPct !== 100 ? '#ff4d4d' : '#00e68e';
    }

    // FUN√á√ïES AUXILIARES
    window.updatePartner = (idx, field, val) => {
        if (field === 'pct') val = parseFloat(val) || 0;
        state.partners[idx][field] = val;
        renderPartners(); // N√£o precisa recalcular tudo, s√≥ redistribuir
        saveState();
    };

    window.removePartner = (idx) => {
        state.partners.splice(idx, 1);
        renderPartners();
        saveState();
    };

    el.btnAddP.addEventListener('click', () => {
        state.partners.push({ id: Date.now(), name: 'S√≥cio', pct: 0 });
        renderPartners();
    });

    const formatMoney = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    async function fetchRate() {
        if (!state.manualRate) {
            el.btnRefresh.style.transform = 'rotate(180deg)';
            try {
                const r = await fetch('https://economia.awesomeapi.com.br/last/USD-BRL');
                const d = await r.json();
                const rate = parseFloat(d.USDBRL.bid);
                // CORRE√á√ÉO: Fixar em 2 casas para display
                el.usdRate.value = rate.toFixed(2);
            } catch(e) { console.error(e); }
            setTimeout(() => el.btnRefresh.style.transform = 'rotate(0deg)', 500);
            updateCalculations('config');
        }
    }

    function saveState() {
        const data = {
            manualRate: state.manualRate,
            usdRate: el.usdRate.value,
            lastSource: state.lastSource,
            devex: el.devex.value,
            fee: el.fee.value,
            tax: el.tax.value,
            extra: el.extra.checked,
            partners: state.partners,
            lastVal: el.robux.value // Salva ultimo input Robux
        };
        localStorage.setItem('devex_ultimate_v6', JSON.stringify(data));
        
        el.toast.style.opacity = '1';
        setTimeout(() => el.toast.style.opacity = '0', 1500);
    }

    function loadState() {
        const d = JSON.parse(localStorage.getItem('devex_ultimate_v6'));
        if (d) {
            state.manualRate = d.manualRate || false;
            state.lastSource = d.lastSource || 'robux';
            el.usdRate.value = d.usdRate || 5.25;
            el.devex.value = d.devex || 0.0038;
            el.fee.value = d.fee || 26;
            el.tax.value = d.tax || 10.82;
            el.extra.checked = d.extra || false;
            if (d.partners) state.partners = d.partners;
            if (d.lastVal) {
                el.robux.value = d.lastVal;
                // Timeout pequeno para garantir que o DOM carregou
                setTimeout(() => updateCalculations('robux'), 50);
            }
            
            el.usdRate.disabled = !state.manualRate;
            el.btnLock.innerText = state.manualRate ? 'üîì' : 'üîí';
        }
    }

    // EVENTOS
    el.robux.addEventListener('input', () => updateCalculations('robux'));
    el.usd.addEventListener('input', () => updateCalculations('usd'));
    el.brl.addEventListener('input', () => updateCalculations('brl'));

    // CORRE√á√ÉO: Ao mudar config, usa 'config' para lembrar qual foi o ultimo input usado
    [el.devex, el.fee, el.tax, el.extra].forEach(x => 
        x.addEventListener('input', () => updateCalculations('config'))
    );

    el.btnLock.addEventListener('click', () => {
        state.manualRate = !state.manualRate;
        el.usdRate.disabled = !state.manualRate;
        el.btnLock.innerText = state.manualRate ? 'üîì' : 'üîí';
        if (!state.manualRate) fetchRate();
        saveState();
    });

    el.usdRate.addEventListener('input', () => updateCalculations('config'));
    el.btnRefresh.addEventListener('click', fetchRate);

    // INICIAR
    loadState();
    if (!state.manualRate) fetchRate();

</script>
</body>
</html>